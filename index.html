<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merry Christmas ğŸ„</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* ç™½å¤©é…è‰² */
      --bg-gradient-day: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 50%, #E0F7FA 100%);
      --text-color-day: #2c3e50;
      --text-shadow-day: 0 0 5px rgba(255, 255, 255, 0.8);
      
      /* é»‘å¤œé…è‰² */
      --bg-gradient-night: linear-gradient(180deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
      --text-color-night: #fff;
      --text-shadow-night: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 40px rgba(255, 255, 255, 0.3);
    }

    body {
      font-family: 'Arial', sans-serif;
      background: var(--bg-gradient-day); /* é»˜è®¤ç™½å¤© */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      transition: background 1s ease;
    }

    /* é»‘å¤œæ¨¡å¼ç±» */
    body.night-mode {
      background: var(--bg-gradient-night);
    }

    /* é›ªèŠ±æ•ˆæœ */
    .snowflake {
      position: absolute;
      top: -10px;
      color: white;
      font-size: 1em;
      font-family: Arial;
      text-shadow: 0 0 2px rgba(0,0,0,0.1);
      animation: fall linear infinite;
      opacity: 0.9;
      z-index: 1;
    }
    
    /* é»‘å¤œæ¨¡å¼ä¸‹é›ªèŠ±æ›´äº® */
    body.night-mode .snowflake {
      text-shadow: 0 0 5px white;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    /* æ ‡é¢˜ */
    h1 {
      color: var(--text-color-day);
      font-size: 3rem;
      margin-bottom: 2rem;
      text-align: center;
      text-shadow: var(--text-shadow-day);
      transition: all 1s ease;
      z-index: 10;
    }
    
    /* é»‘å¤œæ¨¡å¼æ ‡é¢˜ */
    body.night-mode h1 {
      color: var(--text-color-night);
      text-shadow: var(--text-shadow-night);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
          0 0 40px rgba(255, 255, 255, 0.3);
      }
      to {
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
          0 0 60px rgba(255, 255, 255, 0.5),
          0 0 80px rgba(255, 255, 255, 0.3);
      }
    }

    /* åœ£è¯æ ‘å®¹å™¨ */
    .tree-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 5;
    }

    /* Canvasæ ·å¼ */
    #treeCanvas {
      display: block;
      /* ç§»é™¤æ¨¡ç³Šé˜´å½±ï¼Œä¿æŒå¡é€šé£æ ¼çš„æ¸…æ™°è¾¹ç¼˜ */
      filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.1));
      transition: filter 1s ease;
    }
    
    body.night-mode #treeCanvas {
      filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.3));
    }

    /* ç¤¼ç‰©ç›’ - å¡é€šé£æ ¼ */
    .gifts {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      z-index: 5;
    }

    .gift {
      width: 50px;
      height: 50px;
      position: relative;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .gift:nth-child(1) {
      background: #ff4d4d;
      transform: rotate(-5deg);
    }

    .gift:nth-child(2) {
      background: #4d94ff;
      width: 60px;
      height: 60px;
      z-index: 2;
    }

    .gift:nth-child(3) {
      background: #4dff4d;
      transform: rotate(5deg);
    }

    .gift::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 8px;
      background: #ffd700;
      transform: translateY(-50%);
      border-top: 1px solid rgba(255,255,255,0.3);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .gift::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      width: 8px;
      height: 100%;
      background: #ffd700;
      transform: translateX(-50%);
      border-left: 1px solid rgba(255,255,255,0.3);
      border-right: 1px solid rgba(0,0,0,0.1);
    }

    /* éŸ³ä¹æ§åˆ¶æŒ‰é’® */
    .music-control {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .music-control:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .music-control::before {
      content: 'ğŸµ';
      font-size: 24px;
    }

    .music-control.muted::before {
      content: 'ğŸ”‡';
    }
    
    /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
    .mode-toggle {
      position: fixed;
      top: 30px;
      right: 30px;
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      z-index: 100;
      font-size: 24px;
    }
    
    .mode-toggle:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: rotate(15deg);
    }
    
    body.night-mode .mode-toggle {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      color: #fff;
    }

    /* ç¥ç¦ç‰¹æ•ˆ */
    .greeting-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px 50px;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      text-align: center;
      z-index: 1000;
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
    }

    .greeting-popup.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .greeting-text {
      font-size: 2.5rem;
      color: #d63031;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 1px 1px 0 #fff;
    }

    .greeting-sub {
      font-size: 1.2rem;
      color: #2c3e50;
    }

    .close-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #d63031;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.2s;
    }

    .close-btn:hover {
      transform: scale(1.05);
      background: #ff4757;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }

      #treeCanvas {
        width: 90vw;
        height: auto;
      }

      .greeting-text {
        font-size: 1.8rem;
      }
    }
  </style>
</head>

<body>
  <h1>Merry Christmas! ğŸ„</h1>

  <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
  <div class="mode-toggle" id="modeToggle" title="åˆ‡æ¢ç™½å¤©/é»‘å¤œ">â˜€ï¸</div>

  <!-- ç¥ç¦å¼¹çª— -->
  <div class="greeting-popup" id="greetingPopup">
    <div class="greeting-text" id="greetingTitle">Merry Christmas! ğŸ</div>
    <div class="greeting-sub" id="greetingSub">æ„¿ä½ çš„ç”Ÿæ´»å……æ»¡çˆ±ä¸æ¬¢ä¹</div>
    <button class="close-btn" onclick="closeGreeting()">è°¢è°¢åœ£è¯è€äºº!</button>
  </div>

  <div class="tree-container">
    <canvas id="treeCanvas" width="600" height="700"></canvas>

    <!-- ç¤¼ç‰©ç›’ -->
    <div class="gifts">
      <div class="gift"></div>
      <div class="gift"></div>
      <div class="gift"></div>
    </div>
  </div>

  <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
  <div class="music-control" id="musicControl" title="ç‚¹å‡»æ’­æ”¾/æš‚åœéŸ³ä¹"></div>

  <!-- éŸ³é¢‘å…ƒç´  - ä½¿ç”¨æœ¬åœ°éŸ³ä¹æ–‡ä»¶ -->
  <audio id="christmasMusic" loop>
    <source src="merry-christmas.mp3" type="audio/mpeg">
    <source src="merry-christmas.ogg" type="audio/ogg">
    <source src="merry-christmas.wav" type="audio/wav">
  </audio>

  <script>
    const canvas = document.getElementById('treeCanvas');
    const ctx = canvas.getContext('2d');
    const modeToggle = document.getElementById('modeToggle');
    const greetingPopup = document.getElementById('greetingPopup');
    const greetingTitle = document.getElementById('greetingTitle');
    const greetingSub = document.getElementById('greetingSub');
    let isNightMode = false;
    
    // åœ£è¯ç¥ç¦è¯­æ•°ç»„
    const greetings = [
      { title: "Merry Christmas! ğŸ", sub: "æ„¿ä½ çš„ç”Ÿæ´»å……æ»¡çˆ±ä¸æ¬¢ä¹" },
      { title: "åœ£è¯å¿«ä¹! ğŸ„", sub: "æ„¿å¹³å®‰å–œä¹æ°¸è¿œä¼´éšä½ " },
      { title: "Happy Holidays! âœ¨", sub: "ç¥ä½ åº¦è¿‡ä¸€ä¸ªæ¸©é¦¨ç¾å¥½çš„èŠ‚æ—¥" },
      { title: "Season's Greetings! â„ï¸", sub: "æ„¿è¿™ä¸ªå†¬å¤©æ¸©æš–å¦‚æ˜¥" },
      { title: "Joy to the World! ğŸŒŸ", sub: "æ„¿å¹¸ç¦ä¸ä½ åŒåœ¨" },
      { title: "Ho Ho Ho! ğŸ…", sub: "åœ£è¯è€äººç»™ä½ é€æ¥äº†å¥½è¿" },
      { title: "Merry & Bright! ğŸ•¯ï¸", sub: "æ„¿ä½ çš„å‰ç¨‹å¦‚æ˜Ÿå…‰èˆ¬ç’€ç’¨" }
    ];

    // è·å–éšæœºç¥ç¦
    function setRandomGreeting() {
      const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
      greetingTitle.textContent = randomGreeting.title;
      greetingSub.textContent = randomGreeting.sub;
    }
    
    // åœ£è¯è€äººçŠ¶æ€
    const santa = {
      active: false,
      x: 0,
      y: 0,
      angle: 0,
      radius: 0, // ç¯ç»•åŠå¾„
      scale: 0,
      opacity: 0
    };

    // ç²’å­ç³»ç»Ÿ
    class Particle {
      constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type; // 'trail', 'firework', 'sparkle'
        this.life = 1;
        this.decay = Math.random() * 0.02 + 0.01;
        
        if (type === 'trail') {
          this.vx = (Math.random() - 0.5) * 2;
          this.vy = (Math.random() - 0.5) * 2;
          this.color = `hsl(${45 + Math.random() * 15}, 100%, ${50 + Math.random() * 50}%)`; // é‡‘è‰²
          this.size = Math.random() * 3 + 1;
        } else if (type === 'firework') {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 3 + 1;
          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;
          this.color = `hsl(${Math.random() * 360}, 100%, 70%)`;
          this.size = Math.random() * 2 + 1;
          this.gravity = 0.05;
        } else if (type === 'sparkle') {
          this.vx = (Math.random() - 0.5) * 1;
          this.vy = (Math.random() - 0.5) * 1;
          this.color = `hsl(${Math.random() * 360}, 100%, 80%)`;
          this.size = Math.random() * 2 + 0.5;
          this.decay = 0.05;
        }
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= this.decay;
        
        if (this.type === 'firework') {
          this.vy += this.gravity;
        }
      }

      draw(ctx) {
        ctx.save();
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    const particles = [];

    // å…³é—­ç¥ç¦å¼¹çª—
    window.closeGreeting = function() {
      greetingPopup.classList.remove('show');
    }

    // å¯åŠ¨åœ£è¯è€äººåŠ¨ç”»
    function startSantaAnimation() {
      santa.active = true;
      santa.angle = Math.PI; // ä»åé¢å¼€å§‹
      santa.radius = 400; // åˆå§‹å¤§åŠå¾„ï¼ˆè¿œï¼‰
      santa.scale = 0.1; // åˆå§‹å¾ˆå°
      santa.opacity = 0;
      
      // å…³é—­ä¹‹å‰çš„å¼¹çª—
      closeGreeting();
    }
    
    // è§¦å‘çƒŸèŠ±ç‰¹æ•ˆ
    function triggerFireworks() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 3;
      
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const x = centerX + (Math.random() - 0.5) * 400;
          const y = centerY + (Math.random() - 0.5) * 200;
          for (let j = 0; j < 50; j++) {
            particles.push(new Particle(x, y, 'firework'));
          }
        }, i * 300);
      }
    }

    // é¼ æ ‡ç§»åŠ¨äº§ç”Ÿç‰¹æ•ˆ
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // è°ƒæ•´åæ ‡æ¯”ä¾‹
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      for(let i = 0; i < 2; i++) {
        particles.push(new Particle(x * scaleX, y * scaleY, 'sparkle'));
      }
    });

    // æ¨¡å¼åˆ‡æ¢é€»è¾‘
    modeToggle.addEventListener('click', () => {
      isNightMode = !isNightMode;
      document.body.classList.toggle('night-mode');
      modeToggle.textContent = isNightMode ? 'ğŸŒ™' : 'â˜€ï¸';
      
      // åˆ‡æ¢åˆ°å¤œæ™šæ—¶è§¦å‘åœ£è¯è€äººåŠ¨ç”»
      if(isNightMode) {
        startSantaAnimation();
      }
      
      // é‡ç»˜ä»¥æ›´æ–°ç¯å…‰äº®åº¦
      drawTree();
    });
    
    // å“åº”å¼è°ƒæ•´canvaså¤§å°
    function resizeCanvas() {
      const maxWidth = Math.min(600, window.innerWidth - 40);
      const maxHeight = Math.min(700, window.innerHeight - 150);
      const scale = Math.min(maxWidth / 600, maxHeight / 700);
      canvas.style.width = (600 * scale) + 'px';
      canvas.style.height = (700 * scale) + 'px';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // ç¯å…‰æ•°æ® - å›ºå®šä½ç½®ï¼Œç§»é™¤éšæœºç”Ÿæˆ
    const lights = [];
    const decorations = [];

    // åˆå§‹åŒ–è£…é¥°å“å’Œç¯å…‰
    function initDecorations() {
      lights.length = 0;
      decorations.length = 0;
      
      const centerX = 300;
      const layers = [
        { y: 550, width: 380, height: 160 },
        { y: 440, width: 320, height: 140 },
        { y: 340, width: 260, height: 120 },
        { y: 250, width: 200, height: 100 }
      ];
      
      // ç¯å…‰é¢œè‰²
      const colors = ['#ff4d4d', '#ffff4d', '#4d94ff', '#ff4dff'];
      
      layers.forEach((layer, index) => {
        // æ·»åŠ ç¯å…‰
        const numLights = 6 + index;
        for (let i = 0; i < numLights; i++) {
          // å‡åŒ€åˆ†å¸ƒåœ¨å±‚è¾¹ç¼˜é™„è¿‘
          const angle = (i / numLights) * Math.PI + Math.PI; // ä¸‹åŠåœ†
          // éšæœºæ•£å¸ƒåœ¨æ ‘å±‚è¡¨é¢
          const rX = (Math.random() - 0.5) * layer.width * 0.7;
          const rY = (Math.random() - 0.5) * layer.height * 0.6;
          
          lights.push({
            x: centerX + rX,
            y: layer.y - 40 + rY,
            color: colors[Math.floor(Math.random() * colors.length)],
            phase: Math.random() * Math.PI * 2
          });
        }
        
        // æ·»åŠ æ˜Ÿæ˜Ÿè£…é¥°
        const numStars = 3;
        for(let i=0; i<numStars; i++) {
           decorations.push({
             type: 'star',
             x: centerX + (Math.random() - 0.5) * layer.width * 0.8,
             y: layer.y - 20 + (Math.random() - 0.5) * layer.height * 0.5,
             size: 10 + Math.random() * 5,
             rotation: Math.random() * 0.5
           });
        }
        
        // æ·»åŠ æœˆäº®è£…é¥°
        if (index % 2 === 0) {
           decorations.push({
             type: 'moon',
             x: centerX + (Math.random() - 0.5) * layer.width * 0.6,
             y: layer.y - 30,
             size: 12,
             rotation: Math.random() * 0.5
           });
        }
      });
    }
    
    // ç»˜åˆ¶åœ†æ¶¦çš„å¡é€šåœ£è¯è€äºº
    function drawSantaImage(x, y, scale) {
      ctx.save();
      ctx.translate(x, y);
      ctx.scale(scale, scale);
      
      drawSleigh();
      drawSantaBody();
      drawReindeer(120, 20);
      
      ctx.restore();
    }
    
    // ç»˜åˆ¶é›ªæ©‡ - æ›´åŠ åœ†æ¶¦ç²¾è‡´
    function drawSleigh() {
       // é›ªæ©‡ä¸»ä½“ - çº¢è‰²æ¸å˜
       const sleighGradient = ctx.createLinearGradient(0, 0, 0, 50);
       sleighGradient.addColorStop(0, '#ff6b6b');
       sleighGradient.addColorStop(1, '#c0392b');
       
       ctx.fillStyle = sleighGradient;
       ctx.beginPath();
       ctx.moveTo(-60, 20);
       ctx.bezierCurveTo(-60, 60, 40, 60, 60, 20); // åº•éƒ¨æ›´åœ†æ¶¦
       ctx.lineTo(85, 20); // å‰ç«¯ç¿˜èµ·
       ctx.bezierCurveTo(95, 20, 95, -5, 70, -5); // æ‰¶æ‰‹æ›´å¤¸å¼ 
       ctx.lineTo(-40, -5);
       ctx.quadraticCurveTo(-60, -5, -60, 20);
       ctx.fill();
       
       // é‡‘è‰²è£…é¥°å›¾æ¡ˆ
       ctx.strokeStyle = '#f1c40f';
       ctx.lineWidth = 3;
       ctx.lineCap = 'round';
       ctx.beginPath();
       ctx.moveTo(-50, 15);
       ctx.bezierCurveTo(-20, 25, 20, 5, 50, 15);
       ctx.stroke();
       
       // é›ªæ©‡æ»‘æ¿ - é“¶è‰²é‡‘å±æ„Ÿ
       const runnerGradient = ctx.createLinearGradient(0, 30, 0, 50);
       runnerGradient.addColorStop(0, '#bdc3c7');
       runnerGradient.addColorStop(1, '#7f8c8d');
       ctx.strokeStyle = runnerGradient;
       ctx.lineWidth = 5;
       ctx.lineCap = 'round';
       ctx.beginPath();
       ctx.moveTo(-55, 50);
       ctx.lineTo(65, 50);
       ctx.bezierCurveTo(100, 50, 110, 20, 100, 10); // æ»‘æ¿å‰æ®µå·æ›²
       ctx.stroke();
       
       // è¿æ¥æ†
       ctx.lineWidth = 3;
       ctx.beginPath();
       ctx.moveTo(-30, 35);
       ctx.lineTo(-30, 50);
       ctx.moveTo(40, 35);
       ctx.lineTo(40, 50);
       ctx.stroke();
    }
    
    // ç»˜åˆ¶åœ£è¯è€äººèº«ä½“ - Qç‰ˆå¯çˆ±é£
    function drawSantaBody() {
       ctx.save();
       ctx.translate(0, -10);
       
       // èº«ä½“ - åœ†æ»šæ»š
       const bodyGradient = ctx.createRadialGradient(-10, -5, 5, 0, 10, 35);
       bodyGradient.addColorStop(0, '#ff7675');
       bodyGradient.addColorStop(1, '#d63031');
       ctx.fillStyle = bodyGradient;
       ctx.beginPath();
       ctx.ellipse(0, 10, 35, 30, 0, 0, Math.PI * 2);
       ctx.fill();
       
       // è…°å¸¦
       ctx.fillStyle = '#2d3436';
       ctx.beginPath();
       ctx.roundRect(-32, 10, 64, 10, 5);
       ctx.fill();
       
       // é‡‘è‰²å¤§æ‰£å­
       ctx.fillStyle = '#f1c40f';
       ctx.beginPath();
       ctx.roundRect(-10, 8, 20, 14, 3);
       ctx.fill();
       ctx.fillStyle = '#2d3436'; // æ‰£å­å­”
       ctx.beginPath();
       ctx.roundRect(-6, 11, 12, 8, 2);
       ctx.fill();
       
       // è„¸éƒ¨ - ç²‰å«©
       ctx.fillStyle = '#ffeaa7';
       ctx.beginPath();
       ctx.arc(0, -15, 20, 0, Math.PI * 2);
       ctx.fill();
       
       // çœ¼ç› - äº®é—ªé—ª
       ctx.fillStyle = '#2d3436';
       ctx.beginPath();
       ctx.arc(-7, -18, 3, 0, Math.PI * 2);
       ctx.arc(7, -18, 3, 0, Math.PI * 2);
       ctx.fill();
       ctx.fillStyle = '#fff'; // é«˜å…‰
       ctx.beginPath();
       ctx.arc(-8, -19, 1, 0, Math.PI * 2);
       ctx.arc(6, -19, 1, 0, Math.PI * 2);
       ctx.fill();
       
       // è…®çº¢ - æ˜æ˜¾ä¸€ç‚¹
       ctx.fillStyle = 'rgba(255, 118, 117, 0.6)';
       ctx.beginPath();
       ctx.ellipse(-12, -12, 6, 4, 0, 0, Math.PI * 2);
       ctx.ellipse(12, -12, 6, 4, 0, 0, Math.PI * 2);
       ctx.fill();
       
       // å¤§èƒ¡å­ - äº‘æœµçŠ¶
       ctx.fillStyle = '#fff';
       ctx.shadowColor = 'rgba(0,0,0,0.1)';
       ctx.shadowBlur = 5;
       ctx.beginPath();
       ctx.moveTo(-20, -10);
       // ç”¨å¤šä¸ªåœ†å¼§æ¨¡æ‹Ÿè“¬æ¾æ„Ÿ
       ctx.bezierCurveTo(-25, 5, -15, 20, 0, 25); 
       ctx.bezierCurveTo(15, 20, 25, 5, 20, -10);
       ctx.quadraticCurveTo(10, -5, 0, -5);
       ctx.quadraticCurveTo(-10, -5, -20, -10);
       ctx.fill();
       ctx.shadowBlur = 0; // é‡ç½®é˜´å½±
       
       // å¸½å­ - è½¯å¡Œå¡Œ
       ctx.fillStyle = '#d63031';
       ctx.beginPath();
       ctx.moveTo(-20, -25);
       ctx.quadraticCurveTo(0, -55, 25, -30);
       ctx.lineTo(20, -25);
       ctx.fill();
       
       // å¸½å­ç™½è¾¹ - æ¯›èŒ¸èŒ¸
       ctx.fillStyle = '#fff';
       ctx.beginPath();
       ctx.roundRect(-22, -30, 44, 12, 6);
       ctx.fill();
       
       // å¸½å­ç»’çƒ
       const pompomGradient = ctx.createRadialGradient(28, -28, 0, 28, -28, 8);
       pompomGradient.addColorStop(0, '#fff');
       pompomGradient.addColorStop(1, '#dfe6e9');
       ctx.fillStyle = pompomGradient;
       ctx.beginPath();
       ctx.arc(28, -28, 8, 0, Math.PI * 2);
       ctx.fill();
       
       // ç¤¼ç‰©è¢‹ - é¼“é¼“çš„
       const bagGradient = ctx.createRadialGradient(-30, 0, 5, -30, 0, 20);
       bagGradient.addColorStop(0, '#74b9ff');
       bagGradient.addColorStop(1, '#0984e3');
       ctx.fillStyle = bagGradient;
       ctx.beginPath();
       ctx.arc(-30, 0, 18, 0, Math.PI * 2);
       ctx.fill();
       // è¢‹å­å£
       ctx.fillStyle = '#dfe6e9'; 
       ctx.beginPath();
       ctx.ellipse(-30, -15, 8, 4, 0, 0, Math.PI * 2);
       ctx.fill();
       
       ctx.restore();
    }
    
    // ç»˜åˆ¶é©¯é¹¿ - æ›´åŠ å¯çˆ±
    function drawReindeer(x, y) {
       ctx.save();
       ctx.translate(x, y);
       
       // èº«ä½“
       const furGradient = ctx.createRadialGradient(0, 0, 5, 0, 0, 25);
       furGradient.addColorStop(0, '#e67e22');
       furGradient.addColorStop(1, '#d35400');
       ctx.fillStyle = furGradient;
       ctx.beginPath();
       ctx.ellipse(0, 5, 28, 18, 0, 0, Math.PI * 2); // èº«ä½“æ›´åœ†
       ctx.fill();
       
       // å°¾å·´ - å°åœ†çƒ
       ctx.beginPath();
       ctx.arc(-28, 0, 5, 0, Math.PI * 2);
       ctx.fill();
       
       // å¤´ - å¤§è„‘è¢‹
       ctx.beginPath();
       ctx.ellipse(25, -15, 18, 15, 0, 0, Math.PI * 2);
       ctx.fill();
       
       // è…¿ - åŠ¨æ€æ„Ÿ
       ctx.lineWidth = 4;
       ctx.strokeStyle = '#d35400';
       ctx.lineCap = 'round';
       const legOffset = Math.sin(Date.now() * 0.01) * 5; // ç®€å•çš„æ‘†åŠ¨åŠ¨ç”»
       
       ctx.beginPath();
       ctx.moveTo(-15, 15); ctx.quadraticCurveTo(-20, 25, -25 + legOffset, 35);
       ctx.moveTo(-5, 15); ctx.quadraticCurveTo(-5, 25, -5 - legOffset, 35);
       ctx.moveTo(15, 15); ctx.quadraticCurveTo(20, 25, 25 + legOffset, 35);
       ctx.moveTo(25, 15); ctx.quadraticCurveTo(30, 25, 35 - legOffset, 35);
       ctx.stroke();
       
       // çœ¼ç› - å¤§è€Œæœ‰ç¥
       ctx.fillStyle = '#2d3436';
       ctx.beginPath();
       ctx.arc(28, -18, 3, 0, Math.PI * 2);
       ctx.fill();
       ctx.fillStyle = '#fff';
       ctx.beginPath();
       ctx.arc(29, -19, 1.5, 0, Math.PI * 2);
       ctx.fill();
       
       // çº¢é¼»å­ - å‘å…‰
       ctx.shadowColor = '#ff7675';
       ctx.shadowBlur = 10;
       ctx.fillStyle = '#e74c3c';
       ctx.beginPath();
       ctx.arc(38, -12, 6, 0, Math.PI * 2);
       ctx.fill();
       ctx.shadowBlur = 0;
       // é¼»å­é«˜å…‰
       ctx.fillStyle = 'rgba(255,255,255,0.5)';
       ctx.beginPath();
       ctx.arc(36, -14, 2, 0, Math.PI * 2);
       ctx.fill();
       
       // é¹¿è§’ - åœ†æ¶¦
       ctx.strokeStyle = '#8d6e63'; 
       ctx.lineWidth = 3;
       ctx.lineCap = 'round';
       ctx.beginPath();
       ctx.moveTo(22, -25);
       ctx.quadraticCurveTo(25, -40, 35, -35); // ä¸»å¹²
       ctx.moveTo(25, -32);
       ctx.lineTo(20, -38); // åˆ†å‰
       ctx.moveTo(30, -35);
       ctx.lineTo(32, -42);
       ctx.stroke();
       
       // ç¼°ç»³
       ctx.strokeStyle = '#f1c40f';
       ctx.lineWidth = 2;
       ctx.beginPath();
       ctx.moveTo(-45, 0); // è¿æ¥åˆ°é›ªæ©‡
       ctx.bezierCurveTo(-10, 10, 10, 10, 20, -5); // è„–å­
       ctx.stroke();
       
       ctx.restore();
    }

    // ç»˜åˆ¶åœ£è¯è€äººä¸»å‡½æ•°
    function drawSanta() {
      if(!santa.active) return;
      
      const centerX = 300;
      const centerY = 350;
      
      // æ›´æ–°åŠ¨ç”»çŠ¶æ€
      santa.angle += 0.02;
      santa.radius -= 1.5; 
      santa.scale += 0.005; 
      
      if(santa.scale < 1) santa.opacity = Math.min(1, santa.opacity + 0.02);
      
      // ä½ç½®è®¡ç®—
      santa.x = centerX + Math.cos(santa.angle) * santa.radius;
      santa.y = centerY + Math.sin(santa.angle) * (santa.radius * 0.4) - (300 - santa.radius) * 0.5 + Math.sin(santa.angle * 5) * 20;
      
      // ç”Ÿæˆæ‹–å°¾ç²’å­
      if (Math.random() > 0.5) {
        // åœ¨é›ªæ©‡å°¾éƒ¨ä½ç½®ç”Ÿæˆç²’å­
        const tailX = santa.x - 40 * santa.scale; 
        const tailY = santa.y;
        particles.push(new Particle(tailX, tailY, 'trail'));
      }

      // ç»˜åˆ¶
      ctx.save();
      ctx.translate(santa.x, santa.y);
      const baseScale = 0.6 * santa.scale; // ç¨å¾®è°ƒå¤§ä¸€ç‚¹åŸºç¡€æ¯”ä¾‹
      ctx.scale(baseScale, baseScale);
      
      if(Math.sin(santa.angle) > 0) {
         ctx.scale(-1, 1);
      }
      
      ctx.globalAlpha = santa.opacity;
      drawSantaImage(0, 0, 1);
      ctx.restore();
      
      // åŠ¨ç”»ç»“æŸæ¡ä»¶
      if(santa.radius < 50 && santa.scale > 1.2) {
        santa.active = false;
        // éšæœºè®¾ç½®ç¥ç¦è¯­
        setRandomGreeting();
        setTimeout(() => {
          greetingPopup.classList.add('show');
          triggerFireworks(); // è§¦å‘çƒŸèŠ±
        }, 500);
      }
    }

    // ç»˜åˆ¶å¡é€šåœ£è¯æ ‘
    function drawTree() {
      const centerX = 300;
      const baseY = 600;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      drawTrunk(centerX, baseY);
      drawLayer(centerX, 550, 400, 180, '#228B22');
      drawLayer(centerX, 440, 340, 160, '#2E8B57');
      drawLayer(centerX, 340, 280, 140, '#32CD32');
      drawLayer(centerX, 250, 220, 120, '#3CB371');
      
      drawFace(centerX, 380);
      drawDecorations();
      drawTopStar(centerX, 160);
      drawLights();
      
      // æ›´æ–°å¹¶ç»˜åˆ¶ç²’å­ (æ‹–å°¾å’ŒçƒŸèŠ±)
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.update();
        p.draw(ctx);
        if (p.life <= 0) {
          particles.splice(i, 1);
        }
      }

      drawSanta();
    }

    // ç»˜åˆ¶æ ‘å¹² (ä¿æŒä¸å˜)
    function drawTrunk(x, y) {
      ctx.fillStyle = '#8B4513';
      ctx.beginPath();
      ctx.roundRect(x - 30, y - 60, 60, 80, 5);
      ctx.fill();
      ctx.strokeStyle = '#654321';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(x - 10, y - 50);
      ctx.lineTo(x - 10, y - 10);
      ctx.moveTo(x + 10, y - 40);
      ctx.lineTo(x + 10, y - 15);
      ctx.stroke();
    }

    // ç»˜åˆ¶å•å±‚æ ‘å¶ (ä¿æŒä¸å˜)
    function drawLayer(x, y, width, height, color) {
      ctx.fillStyle = color;
      ctx.shadowColor = 'rgba(0,0,0,0.2)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 5;
      ctx.beginPath();
      const left = x - width/2;
      const right = x + width/2;
      const top = y - height;
      const bottom = y;
      ctx.moveTo(x, top);
      ctx.bezierCurveTo(left + width*0.1, top + height*0.5, left - width*0.1, bottom - height*0.3, left, bottom);
      const waveCount = 5;
      const waveWidth = width / waveCount;
      for(let i=0; i<waveCount; i++) {
        const startX = left + i * waveWidth;
        const endX = left + (i + 1) * waveWidth;
        const cp1x = startX + waveWidth * 0.25;
        const cp1y = bottom + 20;
        const cp2x = startX + waveWidth * 0.75;
        const cp2y = bottom + 20;
        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, endX, bottom);
      }
      ctx.bezierCurveTo(right + width*0.1, bottom - height*0.3, right - width*0.1, top + height*0.5, x, top);
      ctx.fill();
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetY = 0;
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
      ctx.beginPath();
      ctx.ellipse(x - width*0.2, y - height*0.5, width*0.15, height*0.2, -0.2, 0, Math.PI * 2);
      ctx.fill();
    }

    // ç»˜åˆ¶å¯çˆ±çš„è„¸ (ä¿æŒä¸å˜)
    function drawFace(x, y) {
      function drawEye(eyeX, eyeY) {
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.arc(eyeX, eyeY, 12, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(eyeX - 4, eyeY - 4, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(eyeX + 3, eyeY + 3, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      drawEye(x - 40, y);
      drawEye(x + 40, y);
      ctx.fillStyle = 'rgba(255, 100, 100, 0.4)';
      ctx.beginPath();
      ctx.ellipse(x - 55, y + 15, 12, 8, 0, 0, Math.PI * 2);
      ctx.ellipse(x + 55, y + 15, 12, 8, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.arc(x, y + 5, 8, 0.2, Math.PI - 0.2);
      ctx.stroke();
    }

    // ç»˜åˆ¶é¡¶éƒ¨å¤§æ˜Ÿæ˜Ÿ (ä¿æŒä¸å˜)
    function drawTopStar(x, y) {
      const size = 35;
      ctx.save();
      ctx.translate(x, y);
      ctx.fillStyle = '#FFD700'; 
      ctx.strokeStyle = '#FFA500'; 
      ctx.lineWidth = 4;
      ctx.lineJoin = 'round'; 
      ctx.beginPath();
      const spikes = 5;
      const outerRadius = size;
      const innerRadius = size * 0.5;
      for (let i = 0; i < spikes * 2; i++) {
        const radius = i % 2 === 0 ? outerRadius : innerRadius;
        const angle = (i * Math.PI) / spikes - Math.PI / 2;
        const cx = Math.cos(angle) * radius;
        const cy = Math.sin(angle) * radius;
        if (i === 0) ctx.moveTo(cx, cy);
        else ctx.lineTo(cx, cy);
      }
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(-8, -2, 3, 0, Math.PI * 2);
      ctx.arc(8, -2, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(0, 3, 5, 0.2, Math.PI - 0.2);
      ctx.stroke();
      ctx.fillStyle = 'rgba(255, 100, 100, 0.5)';
      ctx.beginPath();
      ctx.arc(-12, 5, 4, 0, Math.PI * 2);
      ctx.arc(12, 5, 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }
    
    // ç»˜åˆ¶è£…é¥°å“ (ä¿æŒä¸å˜)
    function drawDecorations() {
       decorations.forEach(deco => {
          ctx.save();
          ctx.translate(deco.x, deco.y);
          ctx.rotate(deco.rotation);
          if(deco.type === 'star') {
             ctx.fillStyle = '#FFFF00';
             ctx.beginPath();
             const r = deco.size;
             for(let i=0; i<10; i++) {
                const angle = i * Math.PI / 5;
                const len = i%2===0 ? r : r/2;
                ctx.lineTo(Math.cos(angle)*len, Math.sin(angle)*len);
             }
             ctx.closePath();
             ctx.fill();
             ctx.strokeStyle = '#eee';
             ctx.lineWidth = 1;
             ctx.beginPath();
             ctx.moveTo(0, -deco.size);
             ctx.lineTo(0, -deco.size - 5);
             ctx.stroke();
          } else if (deco.type === 'moon') {
             ctx.fillStyle = '#9932CC'; 
             ctx.beginPath();
             ctx.arc(0, 0, deco.size, 0.8, 4.8);
             ctx.bezierCurveTo(-deco.size, -deco.size/2, -deco.size, deco.size/2, Math.cos(4.8)*deco.size, Math.sin(4.8)*deco.size);
             ctx.fill();
          }
          ctx.restore();
       });
    }

    // ç»˜åˆ¶ç¯å…‰ (ä¿æŒä¸å˜)
    function drawLights() {
      const time = Date.now() * 0.003;
      lights.forEach(light => {
        const maxBrightness = isNightMode ? 1.0 : 0.7;
        const brightness = 0.5 + Math.sin(time + light.phase) * 0.5 * maxBrightness;
        ctx.save();
        ctx.translate(light.x, light.y);
        const glowSize = (8 + brightness * 5) * (isNightMode ? 1.0 : 0.6);
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, glowSize);
        gradient.addColorStop(0, light.color);
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, glowSize, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.arc(0, 0, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      });
    }

    // åˆå§‹åŒ–åœºæ™¯
    initDecorations();
    
    // åŠ¨ç”»å¾ªç¯
    function animate() {
      drawTree();
      requestAnimationFrame(animate);
    }
    animate();

    // åˆ›å»ºé›ªèŠ± - å¢åŠ éšæœºå¤§å°å’Œé€æ˜åº¦
    function createSnowflake() {
      const snowflake = document.createElement('div');
      snowflake.className = 'snowflake';
      snowflake.innerHTML = 'â„';
      snowflake.style.left = Math.random() * 100 + '%';
      const duration = Math.random() * 3 + 2;
      snowflake.style.animationDuration = duration + 's';
      snowflake.style.opacity = Math.random() * 0.5 + 0.3;
      snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px'; // éšæœºå¤§å°
      snowflake.style.filter = `blur(${Math.random()}px)`; // éšæœºæ¨¡ç³Š
      document.body.appendChild(snowflake);

      setTimeout(() => {
        snowflake.remove();
      }, duration * 1000);
    }

    // å®šæœŸåˆ›å»ºé›ªèŠ±
    setInterval(createSnowflake, 200);

    // éŸ³ä¹æ§åˆ¶
    const musicControl = document.getElementById('musicControl');
    const audio = document.getElementById('christmasMusic');
    let isPlaying = false;

    // å°è¯•æ’­æ”¾éŸ³ä¹
    function tryPlayMusic() {
      if (isPlaying) return;
      
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            musicControl.classList.remove('muted');
            isPlaying = true;
          })
          .catch(err => {
            console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…äº¤äº’:', err);
            // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶æ¥è§¦å‘æ’­æ”¾
            document.body.addEventListener('click', function playOnInteraction() {
              audio.play().then(() => {
                musicControl.classList.remove('muted');
                isPlaying = true;
                document.body.removeEventListener('click', playOnInteraction);
              });
            }, { once: true });
          });
      }
    }

    // å°è¯•ä½¿ç”¨æœ¬åœ°éŸ³ä¹
    audio.addEventListener('error', () => {
      console.log('æ— æ³•åŠ è½½éŸ³é¢‘æ–‡ä»¶');
      musicControl.style.opacity = '0.5';
      musicControl.title = 'éŸ³ä¹æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿é¡¹ç›®ç›®å½•ä¸­æœ‰ merry-christmas.mp3 æ–‡ä»¶';
    });

    // éŸ³é¢‘åŠ è½½æˆåŠŸåå°è¯•æ’­æ”¾
    audio.addEventListener('loadeddata', () => {
      musicControl.style.opacity = '1';
      musicControl.title = 'ç‚¹å‡»æ’­æ”¾/æš‚åœéŸ³ä¹';
      tryPlayMusic(); // å°è¯•è‡ªåŠ¨æ’­æ”¾
    });

    musicControl.addEventListener('click', (e) => {
      e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¨å±€ç‚¹å‡»äº‹ä»¶
      if (isPlaying) {
        audio.pause();
        musicControl.classList.add('muted');
        isPlaying = false;
      } else {
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              musicControl.classList.remove('muted');
              isPlaying = true;
            })
            .catch(err => {
              console.log('æ’­æ”¾å¤±è´¥:', err);
              alert('æ— æ³•æ’­æ”¾éŸ³ä¹ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
            });
        }
      }
    });

    // æ·»åŠ ä¸€äº›åˆå§‹é›ªèŠ±
    for (let i = 0; i < 20; i++) {
      setTimeout(() => createSnowflake(), i * 100);
    }
  </script>
</body>

</html>
